"use client";

import styles from "./TenementCard.module.scss";
import type { Tenement } from "@/entities/tenement";
import Image from "next/image";
import { useState } from "react";

type TenementCardProps = {
  tenement: Tenement;
};

const FALLBACK_IMAGE = "https://placehold.co/600x400/EEE7FF/A540F3?text=No+Image";

const formatPrice = (price: number): string => {
  return price.toLocaleString('de-DE');
};

const getDaysAgo = (date: Date): string => {
  const days = Math.floor((Date.now() - date.getTime()) / (1000 * 60 * 60 * 24));
  if (days === 0) return 'Today';
  if (days === 1) return '1 day ago';
  return `${days} days ago`;
};

export function TenementCard({ tenement }: TenementCardProps) {
  const mainImage = tenement.media?.[0]?.cdnUrl;
  const blurDataURL = tenement.media?.[0]?.bluredDataURL;
  const [imgSrc, setImgSrc] = useState(mainImage || FALLBACK_IMAGE);
  const [hasError, setHasError] = useState(false);

  const agentName = tenement.user
    ? `${tenement.user.firstName || ''} ${tenement.user.lastName || ''}`.trim() || "Agent"
    : tenement.owner?.name || "Agent";

  const companyName = tenement.owner?.name || "Premium Immobilien";

  const pricePerSqm = tenement.rentFull && tenement.size
    ? Math.round(tenement.rentFull / tenement.size)
    : null;

  const handleImageError = () => {
    if (!hasError) {
      setHasError(true);
      setImgSrc(FALLBACK_IMAGE);
    }
  };

  return (
    <div className={styles.card}>
      <div className={styles.imageContainer}>
        <Image
          src={imgSrc}
          alt={tenement.title}
          fill
          sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, (max-width: 1536px) 33vw, 25vw"
          style={{ objectFit: "cover" }}
          placeholder={blurDataURL && !hasError ? "blur" : "empty"}
          blurDataURL={blurDataURL}
          onError={handleImageError}
        />

        <div className={styles.imageOverlay} />

        <button className={styles.favoriteBtn} aria-label="Add to favorites">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="18" viewBox="0 0 20 18" fill="none">
            <path fillRule="evenodd" clipRule="evenodd" d="M4.0095 1.73285C2.48875 2.42768 1.375 4.08135 1.375 6.0531C1.375 8.06701 2.2 9.61985 3.38067 10.9508C4.35508 12.0472 5.53392 12.9565 6.68342 13.842C6.95719 14.0528 7.22761 14.2631 7.49467 14.4727C7.97683 14.8531 8.40675 15.1858 8.822 15.4288C9.23725 15.6717 9.57 15.7817 9.85417 15.7817C10.1383 15.7817 10.472 15.6717 10.8863 15.4288C11.3016 15.1858 11.7315 14.8531 12.2137 14.4727C12.4807 14.2625 12.7511 14.0525 13.0249 13.8429C14.1744 12.9556 15.3533 12.0472 16.3277 10.9508C17.5093 9.61985 18.3333 8.06701 18.3333 6.0531C18.3333 4.08226 17.2196 2.42768 15.6988 1.73285C14.2212 1.05726 12.2357 1.23601 10.3492 3.19676C10.285 3.2633 10.2081 3.31623 10.1231 3.35237C10.038 3.38852 9.94658 3.40716 9.85417 3.40716C9.76175 3.40716 9.67029 3.38852 9.58524 3.35237C9.50019 3.31623 9.4233 3.2633 9.35917 3.19676C7.47267 1.23601 5.48717 1.05726 4.0095 1.73285ZM9.85417 1.76585C7.73483 -0.131654 5.36158 -0.397487 3.4375 0.481596C1.408 1.41201 0 3.56801 0 6.05401C0 8.49693 1.0175 10.3614 2.35308 11.8648C3.42192 13.0683 4.73 14.0758 5.88592 14.9649C6.14869 15.1666 6.40108 15.3628 6.64308 15.5534C7.11333 15.9238 7.6175 16.3179 8.12808 16.6168C8.63867 16.9156 9.22167 17.1576 9.85417 17.1576C10.4867 17.1576 11.0697 16.9147 11.5803 16.6168C12.0918 16.3179 12.595 15.9238 13.0653 15.5534C13.3073 15.3628 13.5596 15.1666 13.8224 14.9649C14.9774 14.0758 16.2864 13.0674 17.3553 11.8648C18.6908 10.3614 19.7083 8.49693 19.7083 6.05401C19.7083 3.56801 18.3013 1.41201 16.2708 0.483429C14.3468 -0.39657 11.9735 -0.130737 9.85417 1.76585Z" fill="black" />
          </svg>
        </button>

        <div className={styles.badges}>
          <div className={styles.verifiedBadge}>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path fillRule="evenodd" clipRule="evenodd" d="M11.3488 0.558675C10.6039 -0.186226 9.39614 -0.186224 8.65124 0.558675L6.83966 2.37026H4.27767C3.22423 2.37026 2.37024 3.22424 2.37024 4.27769V6.83968L0.558675 8.65124C-0.186224 9.39614 -0.186226 10.6039 0.558675 11.3488L2.37024 13.1603V15.7223C2.37024 16.7758 3.22423 17.6297 4.27767 17.6297H6.83966L8.65124 19.4413C9.39614 20.1862 10.6039 20.1862 11.3488 19.4413L13.1603 17.6297H15.7223C16.7757 17.6297 17.6297 16.7758 17.6297 15.7223V13.1604L19.4413 11.3488C20.1862 10.6039 20.1862 9.39614 19.4413 8.65124L17.6297 6.83964V4.27769C17.6297 3.22425 16.7757 2.37026 15.7223 2.37026L13.1603 2.37026L11.3488 0.558675ZM14.2857 8.47097C14.6581 8.09852 14.6581 7.49466 14.2857 7.12221C13.9132 6.74976 13.3093 6.74976 12.9369 7.12221L8.88881 11.1703L7.20286 9.48435C6.83041 9.11191 6.22654 9.11191 5.85409 9.48435C5.48165 9.85681 5.48165 10.4607 5.85409 10.8331L8.14699 13.126C8.55668 13.5357 9.22093 13.5357 9.63062 13.126L14.2857 8.47097Z" fill="#A440F1" />
            </svg>
            <span>Verified</span>
          </div>
        </div>

        <div className={styles.imageFooter}>
          <div className={styles.agent}>
            <div className={styles.agentAvatar}>
              <Image
                src="https://i.pravatar.cc/40?img=12"
                alt={agentName}
                width={36}
                height={36}
                style={{ borderRadius: '50%' }}
              />
            </div>
            <div className={styles.agentInfo}>
              <div className={styles.agentName}>{agentName}</div>
              <div className={styles.companyName}>{companyName}</div>
            </div>
          </div>
          <div className={styles.daysAgo}>
            {tenement.createdAt && getDaysAgo(new Date(tenement.createdAt))}
          </div>
        </div>
      </div>

      <div className={styles.content}>
        <div className={styles.priceSection}>
          <div className={styles.price}>
            {tenement.rentFull > 0 ? `${formatPrice(tenement.rentFull)}€` : "Price on request"}
          </div>
          {pricePerSqm && (
            <div className={styles.pricePerSqm}>{pricePerSqm}€/m²</div>
          )}
        </div>

        <div className={styles.titleSection}>
          <h3 className={styles.title}>{tenement.title}</h3>

          <div className={styles.location}>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M4.26662 3.17326C5.26017 2.19959 6.59782 1.65735 7.98891 1.66437C9.38 1.6714 10.7121 2.22712 11.6958 3.21078C12.6794 4.19444 13.2352 5.52655 13.2422 6.91764C13.2492 8.30873 12.707 9.64638 11.7333 10.6399L8.94262 13.4306C8.69259 13.6806 8.35351 13.821 7.99996 13.821C7.6464 13.821 7.30733 13.6806 7.05729 13.4306L4.26662 10.6399C3.27655 9.64975 2.72034 8.30684 2.72034 6.90659C2.72034 5.50634 3.27655 4.16344 4.26662 3.17326Z" stroke="#0E0E0E" strokeLinejoin="round" />
              <path d="M8 8.90649C9.10457 8.90649 10 8.01106 10 6.90649C10 5.80192 9.10457 4.90649 8 4.90649C6.89543 4.90649 6 5.80192 6 6.90649C6 8.01106 6.89543 8.90649 8 8.90649Z" stroke="#0E0E0E" strokeLinecap="round" strokeLinejoin="round" />
            </svg>
            <span>{tenement.zip} {tenement.city}</span>
          </div>

          <div className={styles.divider} />

          <div className={styles.detailsRow}>
            <div className={styles.detailItem}>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M13.5005 11.0715V4.92953C13.8417 4.84209 14.1537 4.66593 14.4048 4.41892C14.6559 4.17191 14.8372 3.86286 14.9302 3.52314C15.0232 3.18343 15.0247 2.82514 14.9344 2.48467C14.8442 2.1442 14.6655 1.83367 14.4164 1.58461C14.1674 1.33556 13.8568 1.15684 13.5164 1.06661C13.1759 0.976375 12.8176 0.977845 12.4779 1.07087C12.1382 1.16389 11.8291 1.34515 11.5821 1.59625C11.3351 1.84734 11.159 2.15933 11.0715 2.50053H4.92953C4.84209 2.15933 4.66593 1.84734 4.41892 1.59625C4.17191 1.34515 3.86286 1.16389 3.52314 1.07087C3.18343 0.977845 2.82514 0.976375 2.48467 1.06661C2.1442 1.15684 1.83367 1.33556 1.58461 1.58461C1.33556 1.83367 1.15684 2.1442 1.06661 2.48467C0.976375 2.82514 0.977845 3.18343 1.07087 3.52314C1.16389 3.86286 1.34515 4.17191 1.59625 4.41892C1.84734 4.66593 2.15933 4.84209 2.50053 4.92953V11.0715C2.15933 11.159 1.84734 11.3351 1.59625 11.5821C1.34515 11.8291 1.16389 12.1382 1.07087 12.4779C0.977845 12.8176 0.976375 13.1759 1.06661 13.5164C1.15684 13.8568 1.33556 14.1674 1.58461 14.4164C1.83367 14.6655 2.1442 14.8442 2.48467 14.9344C2.82514 15.0247 3.18343 15.0232 3.52314 14.9302C3.86286 14.8372 4.17191 14.6559 4.41892 14.4048C4.66593 14.1537 4.84209 13.8417 4.92953 13.5005H11.0715C11.159 13.8417 11.3351 14.1537 11.5821 14.4048C11.8291 14.6559 12.1382 14.8372 12.4779 14.9302C12.8176 15.0232 13.1759 15.0247 13.5164 14.9344C13.8568 14.8442 14.1674 14.6655 14.4164 14.4164C14.6655 14.1674 14.8442 13.8568 14.9344 13.5164C15.0247 13.1759 15.0232 12.8176 14.9302 12.4779C14.8372 12.1382 14.6559 11.8291 14.4048 11.5821C14.1537 11.3351 13.8417 11.159 13.5005 11.0715ZM13.0005 2.00053C13.1983 2.00053 13.3916 2.05917 13.5561 2.16906C13.7205 2.27894 13.8487 2.43512 13.9244 2.61784C14.0001 2.80057 14.0199 3.00163 13.9813 3.19562C13.9427 3.3896 13.8475 3.56778 13.7076 3.70763C13.5678 3.84748 13.3896 3.94273 13.1956 3.98131C13.0016 4.0199 12.8006 4.00009 12.6178 3.92441C12.4351 3.84872 12.2789 3.72054 12.1691 3.5561C12.0592 3.39165 12.0005 3.19831 12.0005 3.00053C12.0005 2.73531 12.1059 2.48096 12.2934 2.29342C12.481 2.10588 12.7353 2.00053 13.0005 2.00053ZM2.00053 3.00053C2.00053 2.80274 2.05917 2.6094 2.16906 2.44496C2.27894 2.28051 2.43512 2.15233 2.61784 2.07665C2.80057 2.00096 3.00163 1.98115 3.19562 2.01974C3.3896 2.05833 3.56778 2.15357 3.70763 2.29342C3.84748 2.43327 3.94273 2.61145 3.98131 2.80544C4.0199 2.99942 4.00009 3.20048 3.92441 3.38321C3.84872 3.56594 3.72054 3.72211 3.5561 3.832C3.39165 3.94188 3.19831 4.00053 3.00053 4.00053C2.73531 4.00053 2.48096 3.89517 2.29342 3.70763C2.10588 3.5201 2.00053 3.26574 2.00053 3.00053ZM3.00053 14.0005C2.80274 14.0005 2.6094 13.9419 2.44496 13.832C2.28051 13.7221 2.15233 13.5659 2.07665 13.3832C2.00096 13.2005 1.98115 12.9994 2.01974 12.8054C2.05833 12.6115 2.15357 12.4333 2.29342 12.2934C2.43327 12.1536 2.61145 12.0583 2.80544 12.0197C2.99942 11.9812 3.20048 12.001 3.38321 12.0766C3.56594 12.1523 3.72211 12.2805 3.832 12.445C3.94188 12.6094 4.00053 12.8027 4.00053 13.0005C4.00053 13.2657 3.89517 13.5201 3.70763 13.7076C3.5201 13.8952 3.26574 14.0005 3.00053 14.0005ZM11.0715 12.5005H4.92953C4.83968 12.1569 4.65994 11.8434 4.40879 11.5923C4.15765 11.3411 3.84415 11.1614 3.50053 11.0715V4.92953C3.84415 4.83968 4.15765 4.65994 4.40879 4.40879C4.65994 4.15765 4.83968 3.84415 4.92953 3.50053H11.0715C11.1614 3.84415 11.3411 4.15765 11.5923 4.40879C11.8434 4.65994 12.1569 4.83968 12.5005 4.92953V11.0715C12.1567 11.1609 11.8429 11.3405 11.5917 11.5917C11.3405 11.8429 11.1609 12.1567 11.0715 12.5005ZM13.0005 14.0005C12.8027 14.0005 12.6094 13.9419 12.445 13.832C12.2805 13.7221 12.1523 13.5659 12.0766 13.3832C12.001 13.2005 11.9812 12.9994 12.0197 12.8054C12.0583 12.6115 12.1536 12.4333 12.2934 12.2934C12.4333 12.1536 12.6115 12.0583 12.8054 12.0197C12.9994 11.9812 13.2005 12.001 13.3832 12.0766C13.5659 12.1523 13.7221 12.2805 13.832 12.445C13.9419 12.6094 14.0005 12.8027 14.0005 13.0005C14.0001 13.2656 13.8946 13.5197 13.7072 13.7072C13.5197 13.8946 13.2656 14.0001 13.0005 14.0005Z" fill="black" />
              </svg>
              <span>{tenement.size}m²</span>
            </div>
            {tenement.rooms !== null && tenement.rooms > 0 && (
              <div className={styles.detailItem}>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M2 14V12.6667H3.33333V2H10V2.66667H12.6667V12.6667H14V14H11.3333V4H10V14H2ZM7.33333 8.66667C7.52222 8.66667 7.68067 8.60267 7.80867 8.47467C7.93667 8.34667 8.00044 8.18844 8 8C7.99956 7.81156 7.93556 7.65333 7.808 7.52533C7.68044 7.39733 7.52222 7.33333 7.33333 7.33333C7.14444 7.33333 6.98622 7.39733 6.85867 7.52533C6.73111 7.65333 6.66711 7.81156 6.66667 8C6.66622 8.18844 6.73022 8.34689 6.85867 8.47533C6.98711 8.60378 7.14533 8.66756 7.33333 8.66667ZM4.66667 12.6667H8.66667V3.33333H4.66667V12.6667Z" fill="black" />
                </svg>
                <span>{tenement.rooms} {tenement.rooms === 1 ? 'Room' : 'Rooms'}</span>
              </div>
            )}
            {tenement.roomsBath !== null && tenement.roomsBath > 0 && (
              <div className={styles.detailItem}>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M14 8.01477H13.294M13.294 8.01477H2.00065M13.294 8.01477C13.294 9.68143 13.358 11.8028 11.3567 12.3848M2.00065 8.01477L1.99999 4.02477C1.99999 1.13343 5.66665 1.5081 5.66665 4.07543M2.00065 8.01477C2.00065 9.68143 1.93599 11.8028 3.93799 12.3848M11.3567 12.3848C9.26065 12.9974 5.99332 12.9668 3.93799 12.3848M11.3567 12.3848L11.8827 14.0001M5.66665 4.07543H6.37265M5.66665 4.07543H4.96065M3.93799 12.3848L3.41199 14.0001" stroke="black" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
                <span>{tenement.roomsBath} {tenement.roomsBath === 1 ? 'Bath' : 'Baths'}</span>
              </div>
            )}
          </div>

          <div className={styles.detailsRow}>
            {tenement.roomsBed !== null && tenement.roomsBed > 0 && (
              <div className={styles.detailItem}>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M13.334 6.37133V2H12.0007V3.33333H4.00065V2H2.66732V6.37133C1.87398 6.83333 1.33398 7.68333 1.33398 8.66667V11.3333C1.33398 11.5101 1.40422 11.6797 1.52925 11.8047C1.65427 11.9298 1.82384 12 2.00065 12H2.66732V14.6667H4.00065V12H12.0007V14.6667H13.334V12H14.0007C14.1775 12 14.347 11.9298 14.4721 11.8047C14.5971 11.6797 14.6673 11.5101 14.6673 11.3333V8.66667C14.6673 7.68333 14.1267 6.83333 13.334 6.37133ZM12.0007 4.66667V6H8.66732V4.66667H12.0007ZM4.00065 4.66667H7.33398V6H4.00065V4.66667ZM13.334 10.6667H2.66732V8.66667C2.66732 7.93133 3.26532 7.33333 4.00065 7.33333H12.0007C12.736 7.33333 13.334 7.93133 13.334 8.66667V10.6667Z" fill="black" />
                </svg>
                <span>{tenement.roomsBed} {tenement.roomsBed === 1 ? 'Bed' : 'Beds'}</span>
              </div>
            )}
            {tenement.floor && tenement.floor.trim() !== '' && (
              <div className={styles.detailItem}>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M12.5 1.5H3.5C3.23478 1.5 2.98043 1.60536 2.79289 1.79289C2.60536 1.98043 2.5 2.23478 2.5 2.5V13.5C2.5 13.7652 2.60536 14.0196 2.79289 14.2071C2.98043 14.3946 3.23478 14.5 3.5 14.5H12.5C12.7652 14.5 13.0196 14.3946 13.2071 14.2071C13.3946 14.0196 13.5 13.7652 13.5 13.5V2.5C13.5 2.23478 13.3946 1.98043 13.2071 1.79289C13.0196 1.60536 12.7652 1.5 12.5 1.5ZM9.5 9H12.5V10.5H7V9H9.5ZM10 8V6.5H12.5V8H10ZM12.5 2.5V5.5H9.5C9.36739 5.5 9.24021 5.55268 9.14645 5.64645C9.05268 5.74021 9 5.86739 9 6V8H6.5C6.36739 8 6.24021 8.05268 6.14645 8.14645C6.05268 8.24021 6 8.36739 6 8.5V10.5H3.5V2.5H12.5ZM12.5 13.5H3.5V11.5H12.5V13.5Z" fill="black" />
                </svg>
                <span>Floor {tenement.floor}</span>
              </div>
            )}
            <div className={styles.detailItem} style={{ opacity: 0 }}>
              <span></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

